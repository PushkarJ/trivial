require 'rspec'
require_relative '../../models/vulnerability'

RSpec.describe Vulnerability, "#severity" do

  def vuln_data(severity = "LOW", score1 = 1.2, score2 = 9.2)
    {
      "Severity" => severity,
      "CVSS" => {
        "nvd" => {
          "V3Score" => score1
        },
        "redhat" => {
          "V3Score" => score2
        }
      }
    }
  end

  context "when a vulnerability with severity 'CRITICAL' exists with at least one CVSS V3Score of 10" do
    it "returns catastrophic" do
      vuln = Vulnerability.new(vuln_data("CRITICAL", 1.0, 10))
      expect(vuln.severity).to eq("catastrophic")
    end
  end

  context "when a vulnerability with severity 'CRITICAL' exists with at least one CVSS V3Score of 10.0" do
    it "returns catastrophic" do
      vuln = Vulnerability.new(vuln_data("CRITICAL", 1.0, 10.0))
      expect(vuln.severity).to eq("catastrophic")
    end
  end

  context "when a vulnerability with severity 'CRITICAL' exists with no CVSS V3Scores == 10.0" do
    it "returns critical" do
      vuln = Vulnerability.new(vuln_data("CRITICAL", 1.0, 9.9))
      expect(vuln.severity).to eq("critical")
    end
  end

  it "returns downcased Severity" do
    vuln = Vulnerability.new(vuln_data("FOO", 1.0, 9.9))
    expect(vuln.severity).to eq("foo")
  end
end
