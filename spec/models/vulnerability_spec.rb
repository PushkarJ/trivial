require 'rspec'
require_relative '../../models/vulnerability'

RSpec.describe Vulnerability, "#severity" do

  def vuln_data(attrs = {})
    data = {
      severity: "LOW",
      target: "registry.example.org/kube-proxy:v1.19.3.1 (debian 10.5)",
      score1: 1.2,
      score2: 9.2
    }.merge(attrs)
    {
      "Severity" => data[:severity],
      "Target" => data[:target],
      "CVSS" => {
        "nvd" => {
          "V3Score" => data[:score1]
        },
        "redhat" => {
          "V3Score" => data[:score2]
        }
      }
    }
  end

  context "when a vulnerability with severity 'CRITICAL' exists with at least one CVSS V3Score of 10" do
    it "returns catastrophic" do
      vuln = Vulnerability.new(vuln_data(severity: "CRITICAL", score1: 1.0, score2: 10))
      expect(vuln.severity).to eq("catastrophic")
    end
  end


  context "when a vulnerability with severity 'CRITICAL' exists with no CVSS V3Scores == 10.0" do
    it "returns critical" do
      vuln = Vulnerability.new(vuln_data(severity: "CRITICAL", score1: 1.0, score2: 9.9))
      expect(vuln.severity).to eq("critical")
    end
  end

  it "returns downcased Severity" do
    vuln = Vulnerability.new(vuln_data(severity: "FOO"))
    expect(vuln.severity).to eq("foo")
  end
end
